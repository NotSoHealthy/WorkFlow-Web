{# templates/job_offer/index.html.twig #}
{% extends 'layout.html.twig' %}

{% block title %}Job Offers{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .job-offer-form { margin: 20px; }
        .job-offer-table { margin: 20px; width: 90%; }
        .job-offer-table th, .job-offer-table td { padding: 8px; }
        .btn { cursor: pointer; padding: 6px 12px; margin: 2px; }
        .btn-edit { background-color: #f0ad4e; color: #fff; border: none; }
        .btn-delete { background-color: #d9534f; color: #fff; border: none; }
        .btn-submit { background-color: #5cb85c; color: #fff; border: none; }
    </style>
{% endblock %}

{% block main %}
<main>
    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endfor %}

    {# === 1) Create/Update Form === #}
    <div class="job-offer-form">
        <h2>Create / Edit Job Offer</h2>
        {{ form_start(form) }}
            {# Hidden field to track if we are editing an existing offer #}
            <input type="hidden" name="edit_id" id="edit_id" value="" />

            {{ form_row(form.Title) }}
            {{ form_row(form.Description) }}
            {{ form_row(form.Publication_Date) }}
            {{ form_row(form.Expiration_Date) }}
            {{ form_row(form.Contract_Type) }}
            {{ form_row(form.Salary) }}

            <button type="submit" class="btn btn-submit">Save</button>
        {{ form_end(form) }}
    </div>

    {# === 2) Table Listing All Job Offers === #}
    <div class="job-offer-table-container">
        <h2>Existing Job Offers</h2>
        <table class="job-offer-table" border="1">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Publication Date</th>
                    <th>Expiration Date</th>
                    <th>Contract</th>
                    <th>Salary</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for offer in jobOffers %}
                <tr>
                    <td>{{ offer.id }}</td>
                    <td>{{ offer.Title }}</td>
                    <td>
                        {{ offer.Description|length > 30 ? offer.Description|slice(0,30) ~ '...' : offer.Description }}
                    </td>
                    <td>{{ offer.publicationDate ? offer.publicationDate|date('Y-m-d') : '' }}</td>
                    <td>{{ offer.expirationDate ? offer.expirationDate|date('Y-m-d') : '' }}</td>
                    <td>{{ offer.ContractType }}</td>
                    <td>{{ offer.Salary }}</td>
                    <td>
                        {# Edit button to populate form fields #}
                        <button class="btn btn-edit"
                            onclick="editOffer(
                                '{{ offer.id }}',
                                '{{ offer.Title|e('js') }}',
                                '{{ offer.Description|e('js') }}',
                                '{{ offer.publicationDate ? offer.publicationDate|date('Y-m-d') : '' }}',
                                '{{ offer.expirationDate ? offer.expirationDate|date('Y-m-d') : '' }}',
                                '{{ offer.ContractType|e('js') }}',
                                '{{ offer.Salary|default('') }}'
                            )">
                            Edit
                        </button>
                        {# Delete button: form POST to delete route #}
                        <form action="{{ path('job_offer_delete', { id: offer.id }) }}" method="post" style="display:inline;"
                              onsubmit="return confirm('Are you sure you want to delete this offer?');">
                            <button type="submit" class="btn btn-delete">Delete</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% block javascripts %}
        {{ parent() }}
        <script>
            function editOffer(id, title, description, pubDate, expDate, contract, salary) {
                document.getElementById('edit_id').value = id;

                // Populate the form fields
                document.querySelector('[name="job_offer[Title]"]').value = title;
                document.querySelector('[name="job_offer[Description]"]').value = description;
                document.querySelector('[name="job_offer[Publication_Date]"]').value = pubDate;
                document.querySelector('[name="job_offer[Expiration_Date]"]').value = expDate;
                document.querySelector('[name="job_offer[Contract_Type]"]').value = contract;
                document.querySelector('[name="job_offer[Salary]"]').value = salary;
            }
        </script>
    {% endblock %}
</main>
{% endblock %}
