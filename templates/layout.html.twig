{% extends 'base.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="{{ asset('styles/layout.css') }}">
    <style>
.chatbot-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #4f46e5;
    color: white;
    border: none;
    padding: 12px;
    font-size: 20px;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 9999;
}
.chat-bubble {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 300px;
    background: #fff;
    border: 2px solid #4f46e5;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    z-index: 9999;
}
.chat-header {
    padding: 10px;
    background: #4f46e5;
    color: white;
    font-weight: bold;
}
.chat-messages {
    max-height: 250px;
    overflow-y: auto;
    padding: 10px;
}
.chat-input {
    display: flex;
    border-top: 1px solid #eee;
}
.chat-input input {
    flex: 1;
    border: none;
    padding: 10px;
}
.chat-input button {
    background: #4f46e5;
    color: white;
    border: none;
    padding: 10px;
}
</style>
{% endblock %}

{% block body %}
<div class="d-flex" style="min-height: 100vh;">

    <!-- Sidebar -->
    <div class="sidenav" style="width: 250px; background-color: #f8f9fa; padding: 15px;">
        <div class="nav-profile text-center mb-3">
            <img class="nav-profile-img rounded-circle mb-2" src="{{ app.user.imageUrl }}" alt="Profile" width="70" height="70">
            <h6 class="nav-profile-name mb-1">{{ app.user.firstName }} {{ app.user.lastName }}</h6>
        </div>
        <hr class="nav-hr">

        <a class="nav-item nav-link d-block mb-2 {% if app.request.attributes.get('_route') == 'dashboard' %}active{% endif %}" href="#">
            <span class="material-symbols-outlined">dashboard</span> Dashboard
        </a>
        {% if is_granted('ROLE_RESPONSABLE') %}
            <a class="nav-item nav-link d-block mb-2 {% if app.request.attributes.get('_route') starts with 'department' %}active{% endif %}" href="{{ path('department_index') }}">
                <span class="material-symbols-outlined">apartment</span> D√©partements
            </a>
        {% endif %}
        <a class="nav-item nav-link d-block mb-2 {% if app.request.attributes.get('_route') starts with 'project' %}active{% endif %}" href="{{ path('project_index') }}">
            <span class="material-symbols-outlined">groups</span> Projets
        </a>
        {% if is_granted('ROLE_RESPONSABLE') %}
            <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">person</span> Employ√©s</a>
        {% endif %}
        <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">quiz</span> Formations</a>
        <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">calendar_month</span> Ev√©nements</a>
        {% if is_granted('ROLE_RESPONSABLE') %}
            <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">business_center</span> Offres d'emploi</a>
            <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">group_add</span> Candidatures</a>
        {% endif %}
        <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">beach_access</span> Cong√©s</a>
        <a class="nav-item nav-link d-block mb-2" href="#"><span class="material-symbols-outlined">edit</span> R√©clamations</a>
        <a class="nav-item nav-link d-block nav-disconnect mt-4" href="{{ path('app_logout') }}">
            <span class="material-symbols-outlined">logout</span> Se D√©connecter
        </a>
    </div>

    <!-- Main content with tighter padding -->
    <div class="flex-grow-1" style="padding: 10px 15px;">
        {% block main %}{% endblock %}
    </div>
</div>

<!-- Floating Chatbot Button -->
<button id="chatbotBtn" class="chatbot-button">üí¨</button>
<div id="chatBubble" class="chat-bubble d-none">
    <div class="chat-header">
        üßë‚Äçü¶± Gemini Assistant
        <span id="closeChat" style="float:right;cursor:pointer;">‚úñ</span>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="userInput" placeholder="√âcrivez votre question..." />
        <button id="sendBtn">Envoyer</button>
    </div>
</div>

<script>
    const btn = document.getElementById("chatbotBtn");
    const bubble = document.getElementById("chatBubble");
    const close = document.getElementById("closeChat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const messages = document.getElementById("chatMessages");

    btn.onclick = () => bubble.classList.toggle("d-none");
    close.onclick = () => bubble.classList.add("d-none");

    sendBtn.onclick = async () => {
        const userMsg = input.value.trim();
        if (!userMsg) return;

        messages.innerHTML += `<div><strong>Vous:</strong> ${userMsg}</div>`;
        input.value = "";

        const response = await fetch('/gemini/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: userMsg})
        });
        const data = await response.json();

        messages.innerHTML += `<div><strong>Gemini:</strong> ${data.reply}</div>`;
        messages.scrollTop = messages.scrollHeight;
    };
</script>
{% endblock %}